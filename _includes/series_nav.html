{%- comment -%}
Renders a prev/next block for each series on the current page.
Requires:
  page.series: [slug, ...]
  page.series_parts: { slug: number, ... }  (numbers per series)
Works with GitHub Pages (no custom filters).
{%- endcomment -%}

{%- assign series_list = page.series | default: empty -%}
{%- if series_list and series_list.size > 0 -%}
  {%- for s in series_list -%}
    {%- assign slug = s | downcase | strip -%}

    {%- comment -%} Gather members in this series {%- endcomment -%}
    {%- assign members = "" | split: "" -%}
    {%- for p in site.posts -%}
      {%- if p.draft != true and p.series and p.series contains slug -%}
        {%- assign members = members | push: p -%}
      {%- endif -%}
    {%- endfor -%}
    {%- for p in site.payments -%}
      {%- if p.draft != true and p.series and p.series contains slug -%}
        {%- assign members = members | push: p -%}
      {%- endif -%}
    {%- endfor -%}
    {%- for p in site.ach -%}
      {%- if p.draft != true and p.series and p.series contains slug -%}
        {%- assign members = members | push: p -%}
      {%- endif -%}
    {%- endfor -%}
    {%- for p in site.leadership -%}
      {%- if p.draft != true and p.series and p.series contains slug -%}
        {%- assign members = members | push: p -%}
      {%- endif -%}
    {%- endfor -%}
    {%- for p in site.system -%}
      {%- if p.draft != true and p.series and p.series contains slug -%}
        {%- assign members = members | push: p -%}
      {%- endif -%}
    {%- endfor -%}

    {%- assign with_parts = "" | split: "" -%}
    {%- assign no_parts  = "" | split: "" -%}
    {%- for p in members -%}
      {%- assign pn = p.series_parts[slug] -%}
      {%- if pn -%}
        {%- assign with_parts = with_parts | push: p -%}
      {%- else -%}
        {%- assign no_parts = no_parts | push: p -%}
      {%- endif -%}
    {%- endfor -%}

    {%- comment -%} Determine max part to build an ordered list {%- endcomment -%}
    {%- assign max_part = 0 -%}
    {%- for p in with_parts -%}
      {%- assign pn = p.series_parts[slug] | plus: 0 -%}
      {%- if pn > max_part -%}{%- assign max_part = pn -%}{%- endif -%}
    {%- endfor -%}

    {%- assign ordered = "" | split: "" -%}
    {%- for n in (1..max_part) -%}
      {%- for p in with_parts -%}
        {%- if p.series_parts[slug] == n -%}
          {%- assign ordered = ordered | push: p -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endfor -%}

    {%- comment -%} Fallback: append posts without a declared part number by date {%- endcomment -%}
    {%- assign no_parts = no_parts | sort: "date" -%}
    {%- assign ordered = ordered | concat: no_parts -%}

    {%- comment -%} Find the current index {%- endcomment -%}
    {%- assign idx = -1 -%}
    {%- for p in ordered -%}
      {%- if p.url == page.url -%}{%- assign idx = forloop.index0 -%}{%- break -%}{%- endif -%}
    {%- endfor -%}

    <nav class="series-nav">
      <div class="series-label">Series: {{ slug | capitalize }}</div>
      <div class="series-arrows">
        {%- if idx > 0 -%}
          {%- assign prev = ordered[idx | minus: 1] -%}
          <a class="prev" href="{{ prev.url }}">← Part {{ prev.series_parts[slug] | default: "?" }}: {{ prev.title }}</a>
        {%- endif -%}
        {%- if idx >= 0 and idx < ordered.size | minus: 1 -%}
          {%- assign nxt = ordered[idx | plus: 1] -%}
          <a class="next" href="{{ nxt.url }}">Part {{ nxt.series_parts[slug] | default: "?" }}: {{ nxt.title }} →</a>
        {%- endif -%}
      </div>
    </nav>
  {%- endfor -%}
{%- else -%}
  <div class="series-error">⚠️ Add <code>series: [slug]</code> to this post to enable series navigation.</div>
{%- endif -%}

<style>
.series-nav{display:flex;justify-content:space-between;align-items:center;margin-top:1.25rem;padding:.75rem 1rem;border:1px solid #eee;border-radius:10px}
.series-label{font-weight:600;opacity:.9}
.series-arrows a{margin-left:1rem}
.series-error{background:#fff3cd;color:#664d03;padding:.75rem 1rem;border-radius:10px;border:1px solid #ffe69c;margin-top:1rem}
</style>
