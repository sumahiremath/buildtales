{% comment %}
  Advanced Series Navigation Include
  
  This include automatically generates series navigation by:
  1. Finding all posts in the same categories
  2. Sorting them by date
  3. Generating previous/next navigation
  4. Showing series progress and overview
  
  Usage: {% include series-navigation-advanced.html %}
  
  Requirements in post front matter:
  ---
  # Option 1: Use series field (preferred for content reuse)
  series: "payments"  # or "ach" or "leadership"
  categories: [payments, ach]  # Can have multiple categories for reuse
  
  # Option 2: Use single category (fallback)
  categories: [payments]  # Only one category for series
  ---
  
  For content reuse, use the 'series' field to explicitly control which series
  a post appears in, while keeping multiple categories for proper categorization.
{% endcomment %}

{% if page.series %}
  {% assign primary_series = page.series %}
{% elsif page.categories and page.categories.size > 0 %}
  {% assign primary_series = page.categories[0] %}
{% endif %}

{% if primary_series %}
  <!-- Debug: Show which series we're using for navigation -->
  <!-- Primary series: {{ primary_series }} -->
  <!-- All categories: {{ page.categories | join: ', ' }} -->
  
  <!-- Find all posts in this category -->
  {% assign series_posts = "" | split: "" %}
  
  <!-- Check regular posts -->
  {% for post in site.posts %}
    {% if post.categories contains primary_category %}
      {% assign series_posts = series_posts | push: post %}
    {% endif %}
  {% endfor %}
  
  <!-- Check payments collection -->
  {% if primary_series == "payments" %}
    {% for post in site.payments %}
      {% assign series_posts = series_posts | push: post %}
    {% endfor %}
  {% endif %}
  
  <!-- Check ach collection -->
  {% if primary_series == "ach" %}
    {% for post in site.ach %}
      {% assign series_posts = series_posts | push: post %}
    {% endfor %}
  {% endif %}
  
  <!-- Check leadership collection -->
  {% if primary_series == "leadership" %}
    {% for post in site.leadership %}
      {% assign series_posts = series_posts | push: post %}
    {% endfor %}
  {% endif %}
  
  <!-- Sort posts by date or part number -->
  {% assign has_parts = false %}
  {% for post in series_posts %}
    {% if post.part %}
      {% assign has_parts = true %}
      {% break %}
    {% endif %}
  {% endfor %}
  
  {% if has_parts %}
    {% assign sorted_posts = series_posts | sort: "part" %}
  {% else %}
    {% assign sorted_posts = series_posts | sort: "date" %}
  {% endif %}
  {% assign total_posts = sorted_posts | size %}
  
  <!-- Find current post position -->
  {% assign current_position = 0 %}
  {% for post in sorted_posts %}
    {% if post.url == page.url or post.path == page.path %}
      {% assign current_position = forloop.index %}
      {% break %}
    {% endif %}
  {% endfor %}
  
  {% if current_position > 0 and total_posts > 1 %}
    <!-- Series Navigation -->
    <div class="series-navigation-advanced" style="background: #f8f9fa; border-left: 4px solid #157878; padding: 2rem; margin: 2rem 0; border-radius: 0 8px 8px 0;">
      <div class="series-header" style="margin-bottom: 1rem;">
        <h3 style="margin: 0 0 0.5rem 0; color: #157878; font-size: 1.1rem; font-weight: 600;">
          üìö {{ primary_series | capitalize }} Series
        </h3>
        <p style="margin: 0; color: #6c757d; font-size: 0.9rem;">
          Article {{ current_position }} of {{ total_posts }}
        </p>
      </div>
      
      <!-- Progress Bar -->
      <div class="series-progress" style="margin-bottom: 1rem;">
        <div style="width: 100%; background-color: #e9ecef; border-radius: 10px; height: 8px; overflow: hidden;">
          {% assign progress_percent = current_position | times: 100.0 | divided_by: total_posts | default: 0 %}
          <div style="width: {{ progress_percent }}%; background-color: #157878; height: 100%; border-radius: 10px; transition: width 0.3s ease;"></div>
        </div>
        <div style="display: flex; justify-content: space-between; margin-top: 0.5rem; font-size: 0.8rem; color: #6c757d;">
          <span>Started</span>
          <span>{% if total_posts > 0 %}{{ progress_percent | round }}% Complete{% else %}0% Complete{% endif %}</span>
          <span>Finished</span>
        </div>
      </div>
      
      <!-- Navigation Links -->
      <div class="series-links" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
        {% if primary_series == "leadership" %}
          <a href="/series/leadership-systems.html" class="series-link primary" style="background: #157878; color: white; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-size: 0.9rem; font-weight: 500; transition: background-color 0.2s ease;">
        {% else %}
          <a href="/series/{{ primary_series }}.html" class="series-link primary" style="background: #157878; color: white; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-size: 0.9rem; font-weight: 500; transition: background-color 0.2s ease;">
        {% endif %}
          üìã View Series Roadmap
        </a>
        
        {% if current_position > 1 %}
          {% assign prev_post = sorted_posts[current_position | minus: 2] %}
          <a href="{{ prev_post.url }}" class="series-link secondary" style="color: #157878; text-decoration: none; font-size: 0.9rem; padding: 0.5rem 0;">
            ‚Üê {{ prev_post.title | truncate: 40 }}
          </a>
        {% endif %}
        
        {% if current_position < total_posts %}
          {% assign next_post = sorted_posts[current_position] %}
          <a href="{{ next_post.url }}" class="series-link secondary" style="color: #157878; text-decoration: none; font-size: 0.9rem; padding: 0.5rem 0;">
            {{ next_post.title | truncate: 40 }} ‚Üí
          </a>
        {% endif %}
      </div>
      
      <!-- Series Overview -->
      <div class="series-overview" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
        <h4 style="margin: 0 0 0.5rem 0; font-size: 0.9rem; color: #495057; font-weight: 600;">Series Overview:</h4>
        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
          {% for post in sorted_posts %}
            <a href="{{ post.url }}" 
               class="series-part-link {% if post.url == page.url %}current{% endif %}"
               style="display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; text-decoration: none; transition: all 0.2s ease; {% if post.url == page.url %}background: #157878; color: white;{% else %}background: #e9ecef; color: #6c757d;{% endif %}">
              {{ forloop.index }}
            </a>
          {% endfor %}
        </div>
      </div>
      
      <!-- Series Benefits -->
      <div class="series-benefits" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #dee2e6;">
        <p style="margin: 0; font-size: 0.85rem; color: #6c757d; line-height: 1.4;">
          <strong>üí° Series Tip:</strong> 
          {% if current_position == 1 %}
            Start here! This article lays the foundation for understanding {{ primary_series }}.
          {% elsif current_position == total_posts %}
            You've reached the final article! Review the series to see how far you've come.
          {% else %}
            {% if total_posts > 0 %}
              You're {{ progress_percent | round }}% through the {{ primary_series }} series. Keep going!
            {% else %}
              You're making progress through the {{ primary_series }} series. Keep going!
            {% endif %}
          {% endif %}
        </p>
      </div>
    </div>
    
    <style>
      .series-navigation-advanced .series-link:hover {
        opacity: 0.8;
      }
      
      .series-navigation-advanced .series-link.primary:hover {
        background-color: #1a7a7c;
      }
      
      .series-navigation-advanced .series-link.secondary:hover {
        text-decoration: underline;
      }
      
      .series-part-link:hover {
        opacity: 0.8;
        transform: translateY(-1px);
      }
      
      .series-part-link.current {
        font-weight: 600;
      }
      
      @media (max-width: 640px) {
        .series-navigation-advanced {
          padding: 1.5rem;
          margin: 1.5rem 0;
        }
        
        .series-links {
          flex-direction: column;
          align-items: stretch;
        }
        
        .series-link.primary {
          text-align: center;
        }
        
        .series-overview {
          margin-top: 0.75rem;
        }
      }
    </style>
  {% endif %}
{% endif %}
